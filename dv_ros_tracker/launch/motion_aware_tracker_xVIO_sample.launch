<launch>
    <env name="ROSCONSOLE_FORMAT" value="[${severity}] [${time}] [${node}]: ${message}"/>

    <!-- Camera capture node -->
    <node pkg="dv_ros_capture" type="capture_node" name="capture_node" clear_params="true" output="screen"
          required="true">
        <rosparam param="cameraCalibrationFilePath">path_to_calibration_file</rosparam>
    </node>

    <!-- Load camera parameters -->
    <node name="dynamic_reconfigure_load" pkg="dynamic_reconfigure" type="dynparam" args="load /capture_node $(find dv_ros_capture)/config/dynamic.yaml" />

    <!-- Tracker -->
    <node pkg="dv_ros_tracker" type="tracker_node" name="tracker_node_motion_aware" clear_params="true" output="screen" required="true">
        <rosparam command="load" file="$(find dv_ros_tracker)/config/combined_settings.yaml"/>
        <rosparam param="useMotionCompensation" subst_value="true">true</rosparam>

        <remap from="/tracker_node_motion_aware/pose" to="/x_vio/pose"/>
        <remap from="/tracker_node_motion_aware/image" to="/capture_node/camera/image"/>
        <remap from="/tracker_node_motion_aware/events" to="/capture_node/events"/>
        <remap from="/tracker_node_motion_aware/camera_info" to="/capture_node/camera_info"/>
    </node>

    <node pkg="x_vio_ros" type="x_vio_ros" name="x_vio" clear_params="true" output="screen" required="true">
        <!-- Inputs /-->
        <remap from="x_vio/imu" to="/capture_node/imu"/>
        <!-- <remap from="x_vio/image_raw" to="/capture_node/camera/image"/> -->
        <remap from="x_vio/features" to="/tracker_node_motion_aware/keypoints"/>
        <remap from="x_vio/camera_info" to="/capture_node/camera_info"/>
        <remap from="x_vio/range" to="/lrf/range"/>
        <remap from="x_vio/sun_angles" to="/sun_sensor/angles"/>

        <!-- Parameters /-->
        <rosparam file="$(find x_vio_ros)/params.yaml"/>
        <param name="/use_sim_time" value="True"/>
    </node>
    <!-- Disable compressed image outputs -->
    <group ns="x_vio/tracker">
        <rosparam param="disable_pub_plugins">
            - 'image_transport/compressed'
            - 'image_transport/compressedDepth'
            - 'image_transport/theora'
        </rosparam>
    </group>
    <group ns="x_vio/track_manager">
        <rosparam param="disable_pub_plugins">
            - 'image_transport/compressed'
            - 'image_transport/compressedDepth'
            - 'image_transport/theora'
        </rosparam>
    </group>

    <node pkg="rqt_gui" type="rqt_gui" name="gui" args="--perspective-file $(find dv_ros_capture)/config/dynamic_reconfigure_rqt.perspective"/>
    <node type="rviz" name="rviz" pkg="rviz" args="-d $(find x_vio_ros)/cfg/motion_aware.rviz" />
</launch>
